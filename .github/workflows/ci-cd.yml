name: Mobile Test Automation CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build:
    name: Build & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'maven'

      - name: Validate POM
        run: |
          echo "Validating project structure..."
          mvn validate
          echo "POM validation successful"

      - name: Compile Main Sources
        run: |
          echo "Compiling main source files..."
          mvn clean compile -DskipTests
          echo "Main compilation successful"

      - name: Compile Test Sources
        run: |
          echo "Compiling test source files..."
          mvn test-compile
          echo "Test compilation successful"

      - name: Package (skip tests â€” require real device)
        run: |
          echo "Packaging project..."
          mvn package -DskipTests
          echo "Package built successfully"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mobile-test-automation-jar
          path: target/*.jar
          retention-days: 7

      - name: Build Summary
        run: |
          echo "================================================"
          echo "  BUILD SUCCESSFUL"
          echo "================================================"
          echo "  Maven POM      : Validated"
          echo "  Main Sources   : Compiled (12 source files)"
          echo "  Test Sources   : Compiled (5 test files)"
          echo "  Package        : Built"
          echo "  Artifact       : Uploaded"
          echo "  Selenium       : Pinned to 4.17.0 via dependencyManagement"
          echo "  Parallel Exec  : Enabled (ThreadLocal, thread-count=2)"
          echo "  Test Reports   : ExtentReports HTML"
          echo "  Docker Setup   : docker/docker-compose.yml available"
          echo "------------------------------------------------"
          echo "  Mobile tests require a connected Android device"
          echo "  or emulator. Run locally with:"
          echo "    cd docker && docker compose up -d"
          echo "    mvn clean test"
          echo "  Or with local device: mvn clean test"
          echo "================================================"

  docker-validate:
    name: Validate Docker Compose
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Docker Compose
        run: |
          docker compose version

      - name: Validate Docker Compose Syntax
        run: |
          echo "Validating docker-compose.yml..."
          cd docker
          docker compose config
          echo "Docker Compose file is valid"

      - name: Docker Summary
        run: |
          echo "================================================"
          echo "  DOCKER VALIDATION SUCCESSFUL"
          echo "================================================"
          echo "  Services defined:"
          echo "    - android  : Android 11 emulator (budtmo/docker-android)"
          echo "    - appium   : Appium Server 2.x"
          echo "  Appium URL : http://localhost:4723"
          echo "  VNC View   : http://localhost:6080"
          echo "================================================"


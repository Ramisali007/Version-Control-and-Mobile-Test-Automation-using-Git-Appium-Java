# ============================================================
# Dockerized Appium + Android Emulator Setup
# Author: Ramis Ali (22f-3703) | BSSE-8B
#
# USAGE:
#   docker compose up -d          # Start stack
#   docker compose down           # Stop stack
#   docker compose logs -f        # Follow logs
#
# After ~60 seconds the emulator boots.
# Appium server : http://localhost:4723
# Live VNC view : http://localhost:6080 (browser, no password)
# ============================================================

services:

  # ── Android Emulator ──────────────────────────────────────
  android:
    image: budtmo/docker-android:emulator_11.0
    container_name: android-emulator
    privileged: true
    environment:
      - EMULATOR_DEVICE=Samsung Galaxy S10
      - WEB_VNC=true
      - APPIUM=false          # Appium is managed by the separate service below
      - MOBILE_WEB_TEST=false
    ports:
      - "6080:6080"           # noVNC browser view
      - "5554:5554"           # ADB emulator port
      - "5555:5555"           # ADB TCP port
    healthcheck:
      test: ["CMD-SHELL", "adb -s emulator-5554 shell getprop sys.boot_completed | grep 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 120s
    networks:
      - appium-net

  # ── Appium Server ─────────────────────────────────────────
  appium:
    image: appium/appium:latest
    container_name: appium-server
    depends_on:
      android:
        condition: service_healthy
    environment:
      - ANDROID_ADB_SERVER_ADDRESS=android
    ports:
      - "4723:4723"           # Appium REST API
    command: >
      appium
      --address 0.0.0.0
      --port 4723
      --base-path /
      --log-level info
      --relaxed-security
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:4723/status || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 30s
    networks:
      - appium-net

networks:
  appium-net:
    driver: bridge
